<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Installing and running GALLOP on cloud GPUs</h1><p class="page-description">A guide to setting up GALLOP on a GPU-equipped virtual machine using Google Compute Engine</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-11-18T00:00:00-06:00" itemprop="datePublished">
        Nov 18, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Mark Spillman</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#GALLOP">GALLOP</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Cloud">Cloud</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#GCE">GCE</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h1"><a href="#Starting-a-VM">Starting a VM </a></li>
<li class="toc-entry toc-h1"><a href="#Installing-the-CUDA-driver-and-GALLOP">Installing the CUDA driver and GALLOP </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Installing-the-CUDA-driver">Installing the CUDA driver </a></li>
<li class="toc-entry toc-h2"><a href="#Installing-GALLOP-and-running-in-Python-mode">Installing GALLOP and running in Python mode </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Running-GALLOP-via-the-Browser-interface">Running GALLOP via the Browser interface </a></li>
<li class="toc-entry toc-h1"><a href="#Once-finished">Once finished </a></li>
<li class="toc-entry toc-h1"><a href="#Conclusions">Conclusions </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-11-18-Google-Cloud.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
<p><a href="https://github.com/mspillman/gallop"><em>GALLOP</em></a> is designed to run on GPUs and TPUs. Users that don't have local access to GPUs, or who want to gain access to faster GPUs without needing to purchase their own can make use of cloud computing resources. In this post we'll look at how to set up a GPU-equipped virtual machine on Google's <a href="https://cloud.google.com/compute">Compute Engine</a> cloud service, and then use it to run <em>GALLOP</em> jobs both through the <a href="https://mspillman.github.io/blog/gallop/pxrd/python/2021/11/02/Solving-structures-with-GALLOP-browser-interface.html">graphical browser-based interface</a> and via <a href="https://mspillman.github.io/blog/gallop/pxrd/python/2021/11/03/Solving-structures-with-GALLOP-Python-API.html">python mode</a>.</p>
<p>One feature offered by GCE is <em>preemptible</em> instances, which significantly lowers the cost of using resources. There are some limitations that come with this, but they are usually not a concern for GALLOP jobs that take &lt; 24 hours to complete. It's also worth noting that new customers to Google Cloud get $300 free credits to try out their services, so it's well worth having a go. You will need a credit/debit card to gain access to GPUs even though you won't be charged until the free credits run out. You will also need to request an increase to your GPU quota before they can be used - this only took a few minutes to be approved for me.</p>
<p>Lastly, I'm not sponsored or endorsed by Google at all, I just like this service. There are many other cloud GPU providers who may be worth a look to see if they suit your requirements. If you know of any good ones, please get in contact with me, especially if you want to help with providing instructions for other users.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Starting-a-VM">
<a class="anchor" href="#Starting-a-VM" aria-hidden="true"><span class="octicon octicon-link"></span></a>Starting a VM<a class="anchor-link" href="#Starting-a-VM"> </a>
</h1>
<p>Log onto your <a href="https://console.cloud.google.com/home/dashboard">Google Cloud Dashboard</a>. In the top-left hand corner, you'll see the now ubiquitous (at least on Google products) <em>three lines</em> menu button. Click this, and a menu will appear. We are interested in the Compute Engine, so hover over that and an additional menu expansion will appear. Click on VM instances.</p>
<p><img src="/blog/images/copied_from_nb/images/GC_menu.png" alt=""></p>
<p>Once you've done that, we will create our GPU-backed VM! Click on the blue Create Instance button:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_create_instance.png" alt=""></p>
<p>You'll be taken to a menu where we will configure our machine. I am going to select the us-west1 region, though you can choose whichever region you like (provided that you have a GPU-quota in that region).</p>
<p>We then need to make sure we choose a GPU-backed machine, so click on the blue GPU option under Machine family, then select which type of GPU and the number of GPUs you require. For this tutorial, we'll go for a state of the art NVIDIA Tesla A100 GPU. Once you select this, you'll notice a price estimate in the top right hand corner, which is quite expensive! Don't worry, this will come down once we switch to a preemptible instance type.</p>
<p><img src="/blog/images/copied_from_nb/images/GC_select_GPU.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is no need to change the machine type or CPU platform, so our next task is to change the Boot disk. The default is a Debian GNU/Linux environment, we'll change this so that pytorch (one of the libraries that GALLOP depends on) is pre-installed.</p>
<p>To do this, click the "change" button under Boot disk:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_Boot_disk_initial.png" alt=""></p>
<p>Once you do that, a menu will appear. Under Operating system, select <code>Deep Learning on Linux</code>, then in the Version menu, select <code>Deep Learning Image: PyTorch 1.9 m82 CUDA 110</code>. You should end up with something like this:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_Boot_disk_menu.png" alt=""></p>
<p>Once happy, press Select.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The last thing we'll do is set our instance to be preemptible. This will bring the hourly cost down dramatically, though it comes with some restrictions relative to a non-preemptible instance. See <a href="https://cloud.google.com/compute/docs/instances/preemptible">here</a> for more details.</p>
<p>Near the bottom of the page, a blue expandable menu titled "NETWORKING, DISKS, SECURITY, MANAGEMENT, SOLE-TENANCY" is available. Click this to expand. Then click the Management expandable section. Now look down this list for the "Availability policy" menu, which has a drop-down list titled Preemptibility. Click this, and select "On". The price estimate in the top-right corner should reduce significantly!</p>
<p><img src="/blog/images/copied_from_nb/images/GC_preemptibility.png" alt=""></p>
<p>Once you have completed all of the steps above, we are ready to create the instance. Press the blue Create button at the bottom of the page. You will be taken to a new screen which displays the status of the instance, and will allow us to connect to it via a browser-based SSH window. It takes a few minutes for the instances to become accessible, but once it's ready, you should see something like this:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_instances.png" alt=""></p>
<p>To connect to our instance, on the right hand side you'll see an arrow next to "SSH". Click this and then select "Open in browser window". A new window will appear, which will connect to your instance. It will ask you if you want to initiate a connection - press the blue "Connect" button. After a short wait, you will be greeted with the following screen:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_install_driver.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Installing-the-CUDA-driver-and-GALLOP">
<a class="anchor" href="#Installing-the-CUDA-driver-and-GALLOP" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the CUDA driver and <em>GALLOP</em><a class="anchor-link" href="#Installing-the-CUDA-driver-and-GALLOP"> </a>
</h1>
<h2 id="Installing-the-CUDA-driver">
<a class="anchor" href="#Installing-the-CUDA-driver" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the CUDA driver<a class="anchor-link" href="#Installing-the-CUDA-driver"> </a>
</h2>
<p>Once SSH'd into the VM for the first time, I typed <code>y</code>, then pressed enter to install the CUDA driver. This unfortunately failed (I'm not sure why, but this happens frequently! Thankfully, we can fix it quite easily). If yours doesn't fail, proceed onto the GALLOP installation described below, otherwise follow these steps to get the CUDA driver working.</p>
<p>Run the following commands one by one:</p>
<div class="highlight"><pre><span></span>sudo rm /var/lib/apt/lists/lock <span class="o">&amp;&amp;</span> sudo rm /var/cache/apt/archives/lock <span class="o">&amp;&amp;</span> sudo rm /var/lib/dpkg/lock*

sudo dpkg --configure -a

sudo /opt/deeplearning/install-driver.sh
</pre></div>
<p>The last command in particular may take a couple of minutes to run. If any errors occur during these steps, then depending on the error, you may need to run a few more commands to resolve them.</p>
<p>One possible issue is:</p>
<div class="highlight"><pre><span></span>dpkg: error: parsing file <span class="s1">'/var/lib/dpkg/updates/0003'</span> near line <span class="m">0</span>:
 newline in field name <span class="s1">'#padding'</span>
</pre></div>
<p>I solved this issue by running <code>sudo rm /var/lib/dpkg/0003</code>, though you may need to replace <code>0003</code> with whatever number you have on your error.</p>
<p>Another potential issue is the second command complains about the google cloud sdk:</p>
<div class="highlight"><pre><span></span>Errors were encountered <span class="k">while</span> processing:
 google-cloud-sdk
</pre></div>
<p>If this occurs, run the following commands and hopefully it'll work. The first command can take a few minutes to run.</p>
<div class="highlight"><pre><span></span>sudo apt-get upgrade google-cloud-sdk -y
sudo dpkg --configure -a
sudo /opt/deeplearning/install-driver.sh
</pre></div>
<p>If you get any other errors, I found several examples of other people experiencing the same thing on Google so I suggest searching for your error message. Feel free to contact me by email or on Twitter and I can try to help.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Installing-GALLOP-and-running-in-Python-mode">
<a class="anchor" href="#Installing-GALLOP-and-running-in-Python-mode" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing <em>GALLOP</em> and running in Python mode<a class="anchor-link" href="#Installing-GALLOP-and-running-in-Python-mode"> </a>
</h2>
<p>Once the CUDA driver is installed, we're ready to install <em>GALLOP</em>! Run the following command to grab the code from github and install it to the VM.</p>
<div class="highlight"><pre><span></span>git clone https://github.com/mspillman/gallop.git <span class="o">&amp;&amp;</span> <span class="nb">cd</span> gallop <span class="o">&amp;&amp;</span> pip install .
</pre></div>
<p>Once these commands are finished, GALLOP is now installed. If you're running in python mode, then you can upload a script (and diffraction data &amp; ZMs) using the "gear" menu in the top right. Just below you'll also see an option for downloading files which will be of use to obtain your results.</p>
<p><img src="/blog/images/copied_from_nb/images/GC_upload_file.png" alt=""></p>
<p>You may also be interested in using SSH to access JupyterLab</p>
<p><a href="">https://cloud.google.com/vertex-ai/docs/workbench/user-managed/ssh-access</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Running-GALLOP-via-the-Browser-interface">
<a class="anchor" href="#Running-GALLOP-via-the-Browser-interface" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running GALLOP via the Browser interface<a class="anchor-link" href="#Running-GALLOP-via-the-Browser-interface"> </a>
</h1>
<p>To use the browser interface, we'll need to make use of <a href="https://ngrok.com/">ngrok</a> which is available for free. Run the following command to download and unzip the ngrok executable:</p>
<div class="highlight"><pre><span></span>wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-386.zip <span class="o">&amp;&amp;</span> unzip ngrok*.zip
</pre></div>
<p>We then need to setup ngrok with our authoken.</p>
<p>Run the following command, but ensure you paste in your authtoken in the space I've indicated. This will be pre-populated in "step 2" on your <a href="https://dashboard.ngrok.com/get-started/setup">ngrok homepage</a>.</p>
<div class="highlight"><pre><span></span>./ngrok authtoken <span class="o">[</span>authtoken goes here<span class="o">]</span>
</pre></div>
<p>Once this is done, we will first start the browser interface running in a background process:</p>
<div class="highlight"><pre><span></span>streamlit run gallop_streamlit.py <span class="p">&amp;</span>&gt;/dev/null <span class="p">&amp;</span>
</pre></div>
<p><img src="/blog/images/copied_from_nb/images/GC_streamlit_background.png" alt=""></p>
<p>The process ID displayed will allow you to kill streamlit if needed with the command <code>kill 9943</code> command, where you replace <code>9943</code> with the process ID that is displayed.</p>
<p>Lastly, to get our ngrok link and access the <em>GALLOP</em> browser interface, run:</p>
<div class="highlight"><pre><span></span>./ngrok http <span class="m">8501</span>
</pre></div>
<p>And the following will appear:</p>
<p><img src="/blog/images/copied_from_nb/images/GC_ngrok.png" alt=""></p>
<p>Click on the Forwarding URL and you will be taken to the GALLOP browser interface.</p>
<p>Note - when I tried it, Google Chrome complained that it suspected it was some sort of phishing attempt but Firefox opened the URL without complaint. Not sure what happened there, but if you get a concerning red screen, I suggest switching to Firefox!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Once-finished">
<a class="anchor" href="#Once-finished" aria-hidden="true"><span class="octicon octicon-link"></span></a>Once finished<a class="anchor-link" href="#Once-finished"> </a>
</h1>
<p>Once you're finished, you may wish to stop, suspend or delete your instance in order to avoid incurring any additional fees. Press the small three-dots menu on the right hand side of your instances page, and various options will appear.</p>
<p><img src="/blog/images/copied_from_nb/images/GC_delete_instance.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusions">
<a class="anchor" href="#Conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusions<a class="anchor-link" href="#Conclusions"> </a>
</h1>
<p>In this post, we've seen how to get a preemptible GPU-equipped VM running on Google Compute Engine, and install the CUDA driver and <em>GALLOP</em> on it.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="mspillman/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/gallop/cloud/gce/2021/11/18/Google-Cloud.html" hidden></a>
</article>